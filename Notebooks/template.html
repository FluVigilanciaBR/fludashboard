<html>
<head> 
<meta http-equiv="content-type" content="text/html; charset=UTF8">

<link 
    rel="stylesheet" 
    type="text/css" 
    href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-alpha.5/dc.css"/> 
<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"
></script> 
<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"
></script> 

<link
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css" 
/>
<script 
    src="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.js"
></script>

<script 
    src="https://code.jquery.com/jquery-2.2.4.min.js" 
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" 
    crossorigin="anonymous"
></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"
></script>
    
<script
    src="https://rawgit.com/NickQiZhu/dc.js/master/web/js/dc.js"
></script>

<style>

.chart {
    margin-left:90px;
}
.table-hover tbody tr:hover td, .table-hover tbody tr:hover th {
    background-color: #f5f5f5;
}
.table th, .table td {
    padding: 2px;
    line-height: 20px;
    text-align: left;
    vertical-align: top;
    border-top: 1px solid #ddd;
}
user agent stylesheettd, th {
    display: table-cell;
    vertical-align: inherit;
}

</style>

</head>

<body>

<div>
Period (week):
<select id="week">
    <option value="0">Whole Year</option>
    {%for w in range(1, 53):%}
    <option value="{{w}}" 
            {{'selected="selected"' if w==current_isoweek else ''}}
            >{{w}}</option>
    {%endfor%}  
</select>

<input type="hidden" id="selected_state" value=""/>
</div>

<div id="map" style="height:250px;width:500px;"></div>

<div>
<table id="data-table" class='table'>
 <!-- create a custom header -->
    <thead class="header">
        <tr class="header">
        <th>State</th>
        <th>Incidence</th>
        <th>Age</th>
        <th>Alert</th>
        </tr>
    </thead>
</table>
<div>

<!-- A div anchor that can be identified by id -->
<div id="linechart" class="dc-chart" style="display:none;">
    <!-- Title or anything you want to add above the chart -->
    <strong>Series Chart</strong>
    <!--
        This will create a reset button when ever the user selects a filter.
        Clicking on the reset button will remove all filters.
     -->
    <a class="reset" href="javascript:void(0);" onclick="javascript:LineChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="clearfix"></div>
    <!--
        dc.js will also automatically inject applied current filter value into
        any html element with css class set to "filter"
    -->
    <span class="reset" style="display: none;">Current filter: <span class="filter"></span></span>
    <br/>
    <br/>
</div>

<div id="rowchart" class="dc-chart" style="display:none;">
    <!-- Title or anything you want to add above the chart -->
    <strong>Age Chart</strong>
    <!--
        This will create a reset button when ever the user selects a filter.
        Clicking on the reset button will remove all filters.
     -->
    <a class="reset" href="javascript:void(0);" onclick="javascript:RowChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="clearfix"></div>
    <!--
        dc.js will also automatically inject applied current filter value into
        any html element with css class set to "filter"
    -->
    <span class="reset" style="display: none;">Current filter: <span class="filter"></span></span>
    <br/>
    <br/>
</div>
    
<script>
console.clear();

function filter_apply(filter) {
    var f=eval(filter);
    
    if (typeof(f.length) != "undefined") {} else {};
    
    if (typeof(f.top) != "undefined") {f=f.top(Infinity);} else {};
    
    if (typeof(f.dimension) != "undefined") {
        f=f.dimension(function(d) { return "";}).top(Infinity);
    } else {};
    
    return f;
}


function print_filter(filter){
    f = filter_apply(filter);
    
    console.log(
        filter + "(" + f.length + ") = " + 
        JSON.stringify(f)
    );
}

// Create Global Variables
/*var RowChart = dc.rowChart("#rowchart");
var LineChart = dc.lineChart("#linechart");*/
var DataTable = dc.dataTable("#data-table");

// Load data
var dataset = {{ data }};
var br_states = {{ br_states }};

var flu_colors = {
    1: 'green',
    2: 'yellow',
    3: 'orange',
    4: 'red',
};

// Create function
function Graph(data) {
    var map = L.map('map');
    map.setView([-16, -50.528742], 3);
    
    // create the tile layer with correct attribution
    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
    var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 12, attribution: osmAttrib});
    
    function onEachFeature(feature, layer) {
        //bind click
        layer.on({
            click: function(){
                // reset line weight
                geojson_layer.eachLayer(function (_layer) {  
                    _layer.setStyle({
                        weight: 1
                    });
                });
                // bold the selected state
                layer.setStyle({
                    weight: 2
                });
                
                $('#selected_state').val(feature.properties.nome);
            }
        });
    }
    
    /**
     * Red if the incidence was above the high threshold for at least 5 weeks;
     * Orange if above the high threshold from 1 to 4 weeks;
     * Yellow if crossed the epidemic threshold but not the high one;
     * Green if it did not cross the epidemic threshold.
    */
    function alert_level_for_whole_year(d) {
        if (d[4] >= 5) return 4;
        if (d[4] >= 1 && d[4] < 5) return 3;
        if (d[2] >= 1 || d[3] >= 1) return 2;
        return 1;
    }
    
    // Feed it through crossfilter  
    var ndx = crossfilter(data);
    
    // for testing
    //console.log(data);
    
    //define a dimension
    //Here we will group by state
    var stateDim = ndx.dimension(dc.pluck('Unidade_da_Federação'));
    var weekDim = ndx.dimension(dc.pluck('isoweek'));
    
    var ufAlertDim = ndx.dimension(function (d) {
        //stringify() and later, parse() to get keyed objects
        return JSON.stringify({'uf': d['Unidade_da_Federação'], 'alert': d['alert']});
    });

    ufAlertGroup = ufAlertDim.group();
    //this forEach method could be very expensive on write.
    ufAlertGroup.all().forEach(function(d) {
        //parse the json string created above
        d.key = JSON.parse(d.key);
    });
    
    // start the map in South-East England
    geojson_layer = L.geoJson(br_states, {
        onEachFeature: onEachFeature,
        style: function(feature) {
            l_name = feature.properties.nome;
            isoweek = $('#week').val();
            
            result = {
                fillColor: 'white',
                color: '#333333',
                opacity: 1,
                weight: 1
            };
            
            weekDim.filterAll();
            df = filter_apply(weekDim.filter(isoweek));

            $(df).each(function(i){ 
                if (l_name == df[i]['Unidade_da_Federação']){
                    result = {
                        fillColor: flu_colors[df[i]['alert']],
                        color: '#333333',
                        opacity: 1,
                        weight: 1
                    };
                    return;
                }
            });            
            return result;
        }
    });
    geojson_layer.addTo(map);
    osm.addTo(map)
    
    d3.select('#week')
        .on('change', function(){ 
            isoweek = $('#week').val();
            
            result = {
                fillColor: 'white',
                color: '#333333',
                opacity: 1,
                weight: 1
            };
        
            weekDim.filterAll();
            //print_filter(df);
            geojson_layer.eachLayer(function (layer) {  
                l_name = layer.feature.properties.nome;
                
                if(isoweek>0) {
                    df = filter_apply(
                        weekDim.filter(isoweek)
                    );
                    $(df).each(function(i){ 
                        if (l_name == df[i]['Unidade_da_Federação']){
                            layer.setStyle({
                                fillColor: flu_colors[df[i]['alert']],
                                color: '#333333',
                                opacity: 1
                            });
                        }
                    });
                } else {
                    df = filter_apply(ufAlertGroup.all());
                    alerts = {};

                    $(df).each(function(i){ 
                        if (l_name == df[i].key['uf']){
                            alerts[df[i].key['alert']] = df[i].value;
                        }
                    });

                    layer.setStyle({
                        fillColor: flu_colors[alert_level_for_whole_year(alerts)],
                        color: '#333333',
                        opacity: 1,
                        weight: 1
                    });
                }
            });
            dc.renderAll(); // render all charts on the page
    });
    
    //Here we group by state and sum on column population
    var stateGroup = stateDim.group().reduceSum(dc.pluck('incidence'));
    
    /*
    //Lets create a row chart
    RowChart.dimension(stateDim)
        .group(stateGroup)
        .width(500);
        
    RowChart.getColor = function(d, i){
        var flu_colors = {
            1: '#dfdfdf',
            2: '#ffcc00',
            3: '#ff0000',
            4: '#00ff00',
        };
        return flu_colors[d.alert];
    };
    */
    
    DataTable.dimension(weekDim)
        // data table does not use crossfilter group but rather a closure
        // as a grouping function
        .group(function(d) {
            return '';
        })
        .columns([
            dc.pluck('Unidade_da_Federação'),
            dc.pluck('incidence'),
            dc.pluck('age'),
            dc.pluck('alert'),
        ])
        .size(100)
        .sortBy(dc.pluck('Unidade_da_Federação'))
        .order(d3.ascending);
    
    dc.renderAll(); // render all charts on the page
    
}; // end graph function    

// Call function
Graph(dataset);
</script>
    
</body>
</html>